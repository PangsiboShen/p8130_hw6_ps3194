---
title: "p8130_hw6_ps3194"
author: "Pangsibo Shen"
date: "12/3/2020"
output: html_document
---

```{r}
library(tidyverse)
```
### Problem 1

```{r}
#load the data
pat_satisfaction = read_csv("./data/PatSatisfaction.csv") %>%
  janitor::clean_names()
```

#### 1)

**Create a correlation matrix for all variables and interpret your findings. Focus on the correlation values between each predictor and the outcome of interest.**

```{r}
round(cor(pat_satisfaction),3)

# Scatter plot matrix for all variables
pairs(pat_satisfaction)
```
The estimated correlation between satisfaction and age is -0.787; between satisfaction and severity is -0.603; between satisfaction and anxiety is -0.643; between age and severity is 0.568; between age and anxiety is 0.570; between severity and anxiety is 0.671. Therefore, there are strong negative linear relationships between satisfaction(outcome) and age; between satisfaction(outcome) and severity and between satisfaction(outcome) and anxiety.


#### 2)

**Fit a multiple regression model including all three predictors and test whether at least one of these variables is significant. State the hypotheses, test-statistic, decision rule and conclusion.**


$$
\begin{split}
H_0: \beta_1 = \beta_2 =\beta_3 =0\\
H_1: the \ least \ one \ \beta \ is \ not \ zero\\
F = \frac{MSR}{MSE}=\frac{3040.155}{101.1629}=30.05208 \\
F(1-\alpha;p,n-p-1) = 2.816466
\end{split}
$$

```{r}
fit_1 = lm(safisfaction~age + severity + anxiety, data = pat_satisfaction)
anova(fit_1)
MSR = sum(anova(fit_1)[1:3, 'Sum Sq'])/3
MSE = anova(fit_1)['Residuals', 'Mean Sq']
F_stats = MSR/MSE

```
For the F statistics, we got `r F_stats` which is greater than the F critical value (`r qf(0.95,3,44)`). Hence we reject the null hypothesis and conclude that at significance level of 0.05, there are some estimated slope coefficients are nonzero.


#### 3)
**Show the regression results for all estimated slope coefficients with 95% CIs. Interpret the coefficient and 95% CI associated with ‘severity of illness’.**

The formula for a(1-$\alpha$)100% confidence for the true slope is given by below:

$$
\begin{split}
\hat{\beta_i} \pm t_{n-2,1-\alpha/2}*se(\hat{\beta_i})\\
where \ se(\hat{\beta_i}) = \sqrt{\frac{MSE}{\sum_{j=1}^n(x_j-\bar{x})}} \\

\end{split}
$$
```{r}
summary(fit_1)
confint(fit_1,level=0.95)
```
The estimated slope coefficients with 95% CIs for ‘age’: (-1.575093, -0.7081303); for ‘severity’: (-1.434831, 0.5508228); for ‘anxiety’: (-27.797859, 0.8575324). 

#### 4)

Obtain an interval estimate for a new patient’s satisfaction with the following characteristics: Age=35, Severity=42, Anxiety=2.1. Interpret the interval.

```{r}
newdata = data.frame(age = 35, severity = 42, anxiety = 2.1)
predict.lm(fit_1, newdata, interval = "confidence")
```

#### 5a)

Test whether ‘anxiety level’ can be dropped from the regression model, given the other two. covariates are retained. State the hypotheses, test-statistic, decision rule and conclusion.

$$
\begin{split}
H_0: small \ model\\
H_1: large \ model\\
F = \frac{(SSE_L-SSE_S)/(df_L-df_S)}{SSE_L/df_L}=\frac{364.1595}{107.2791}=3.394507 \\
F(1-\alpha;df_L-df_S,df_L) = 4.067047
\end{split}
$$
```{r}
#create a small model excluding anxiety level
fit_2 = lm(safisfaction~age + severity, data = pat_satisfaction)

model_compare <- function(reg1, reg2){
  d1 <- dim(anova(reg1))[[1]]
  d2 <- dim(anova(reg2))[[1]]
  a1 <- anova(reg1)
  a2 <- anova(reg2)
  num <- (a1$`Sum Sq`[d1] - a2$`Sum Sq`[d2])/(a1$Df[d1] - a2$Df[d2])
  deno <- a2$`Sum Sq`[d2]/a2$Df[d2]
  Fstat <- num/deno

  return(list(num=num, deno=deno, Fstat=Fstat))
}

model_compare(fit_1,fit_2)

anova(fit_1,fit_2)

qf(0.95,1,43)
```
fail to reject the null hypothesis and we can conclude that at significance level of 0.05, the small model is 'superior.'


#### 5b)

How are R2/R2-adjusted impacted by the action that you took in part 5-a)?
```{r}
summary(fit_1)
summary(fit_2)
```

----------------------------------
### Problem 1

```{r}
#load the data
estradiol_df = read_csv("./data/Estradl.csv") %>%
  janitor::clean_names()
```

#### 1) Is there a crude association between BMI and serum estradiol

##### a) Generate a scatter plot with the overlaid regression line. Comment.

```{r}
fit_3 = lm(estradl~bmi, data = estradiol_df)
plot(estradiol_df$estradl, estradiol_df$bmi)
abline(fit_3,lwd=2,col=2)
```
##### b) Provide the summary regression output and comment on the nature of the relationship (i.e.,sign, magnitude, significance).

```{r}
summary(fit_3)
```
No significance

#### 2) 

How does the relationship between BMI and serum estradiol change after controlling for all the other risk factors listed above? Provide the summary regression output and comment on the relationships observed for each of the predictors.

```{r}
fit_4 = lm(estradl~ factor(ethnic) + entage+ numchild + numchild + bmi, data = estradiol_df)
summary(fit_4)
```
#### 3) 

Now focus only the relationship between BMI and serum estradiol by ethnicity. Is there any evidence that these relationships vary for African American and Caucasian women? 

##### a) 
Use graphical displays and numerical summaries to sustain your conclusion.
```{r}
qplot(x = bmi, y = estradl, data = estradiol_df, color = factor(ethnic)) +
     geom_smooth(method = "lm", se=FALSE) +
     labs(x="bmi", y="Estradiol hormonal serum levels")
```

##### b) 
Based on your response in part 3-a), take additional steps to quantify the relationship between
BMI and serum estradiol by ethnicity. Comment on your findings.

```{r}
fit_5 = lm(estradl~ bmi*factor(ethnic), data = estradiol_df)
summary(fit_5)
anova(fit_5)
```



